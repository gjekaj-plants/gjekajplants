<!doctype html>
<html lang="sq">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gjekaj Plants ‚Äî Katalogu i Bim√´ve</title>
  <meta name="description" content="Gjekaj Plants ‚Äî Katalogu i bim√´ve. K√´rko, filtro dhe d√´rgo porosin√´ n√´ WhatsApp." />

  <style>
    :root{
      --bg:#f4f6f8;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --header:#0b1220;
      --border:#e5e7eb;
      --shadow: 0 10px 30px rgba(2,6,23,.08);
      --btn:#0b1220;          /* butoni ‚ÄúShto n√´ shport√´‚Äù i zi */
      --btnText:#ffffff;
      --price:#b91c1c;        /* √ßmimi i kuq */
      --chip:#eef2f7;
      --link:#2563eb;
      --danger:#b91c1c;
      --ok:#16a34a;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:var(--bg);
    }

    /* Header */
    header{
      background:linear-gradient(180deg, rgba(11,18,32,1), rgba(11,18,32,.92));
      color:#fff;
      padding:22px 14px 18px;
      position:sticky;
      top:0;
      z-index:50;
      box-shadow: 0 8px 24px rgba(2,6,23,.18);
    }
    .brand{
      max-width:1200px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      text-align:center;
    }
    .brand h1{
      margin:0;
      font-size:clamp(22px, 3.2vw, 38px);
      letter-spacing:.2px;
    }
    .brand .sub{
      color:rgba(255,255,255,.78);
      font-size:14px;
    }
    .brand a{ color:#93c5fd; text-decoration:none; }
    .brand a:hover{ text-decoration:underline; }

    /* Layout */
    .wrap{
      max-width:1200px;
      margin:18px auto 70px;
      padding:0 12px;
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }

    /* Desktop: grid + cart on right */
    @media (min-width: 980px){
      .wrap{
        grid-template-columns: 1.4fr .6fr;
        align-items:start;
      }
      .cart{
        position:sticky;
        top:110px;
      }
    }

    /* Cards */
    .panel{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .inner{ padding:14px; }

    /* Filters */
    .filters{
      display:grid;
      gap:10px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 720px){
      .filters{
        grid-template-columns: 1.4fr .9fr .7fr;
        align-items:end;
      }
    }

    label{
      font-size:13px;
      color:var(--muted);
      display:block;
      margin:0 0 6px;
      font-weight:600;
    }
    input, select, textarea{
      width:100%;
      border:1px solid var(--border);
      border-radius:12px;
      padding:11px 12px;
      background:#fff;              /* fusha t√´ bardha */
      color:var(--text);
      outline:none;
      font-size:15px;
    }
    textarea{ min-height:72px; resize:vertical; }
    input:focus, select:focus, textarea:focus{
      border-color:#94a3b8;
      box-shadow: 0 0 0 4px rgba(148,163,184,.25);
    }

    .metaRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-top:10px;
      color:var(--muted);
      font-size:13px;
    }
    .status{
      font-weight:700;
      color:var(--muted);
    }
    .status.ok{ color:var(--ok); }
    .status.err{ color:var(--danger); }

    /* Products grid */
    .grid{
      padding:14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    @media (min-width: 680px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }
    @media (min-width: 980px){
      .grid{ grid-template-columns: 1fr 1fr 1fr; }
    }

    .product{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      overflow:hidden;
      box-shadow: 0 10px 24px rgba(2,6,23,.06);
      display:flex;
      flex-direction:column;
      min-height: 100%;
    }
    .pimg{
      width:100%;
      height:210px;
      background:#e5e7eb;
      display:block;
      object-fit:cover;
    }
    .pbody{ padding:12px 12px 12px; display:flex; flex-direction:column; gap:8px; }
    .ptitle{
      font-size:22px;
      font-weight:900;
      margin:0;
      letter-spacing:.2px;
      text-transform:none;
    }
    .details{
      color:var(--muted);
      font-size:14px;
      line-height:1.45;
    }
    .details b{ color:#334155; }

    .priceRow{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      margin-top:2px;
    }
    .lek{
      font-size:40px;
      font-weight:1000;
      color:var(--price);          /* √ßmimi i kuq */
      letter-spacing:.3px;
    }
    .eur{
      font-size:20px;
      font-weight:900;
      color:var(--price);          /* edhe euro me t√´ kuqe (si te foto) */
      opacity:.95;
      white-space:nowrap;
    }

    .desc{
      color:#334155;
      font-size:14px;
    }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      margin-top:6px;
    }
    .qty{
      width:76px;
      text-align:center;
      font-weight:800;
    }
    .btn{
      border:0;
      border-radius:14px;
      padding:12px 14px;
      font-weight:900;
      cursor:pointer;
      transition: transform .05s ease, opacity .15s ease;
      user-select:none;
    }
    .btn:active{ transform: scale(.99); }
    .btnAdd{
      flex:1;
      background:var(--btn);     /* butoni i zi */
      color:var(--btnText);
      font-size:15px;
    }
    .btnAdd:hover{ opacity:.92; }

    /* Cart */
    .cartHead{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .cartHead h3{
      margin:0;
      font-size:22px;
      font-weight:1000;
    }
    .badge{
      background:var(--chip);
      border:1px solid var(--border);
      border-radius:999px;
      padding:6px 10px;
      font-weight:900;
      font-size:13px;
      color:#0f172a;
    }

    .cartInner{ padding:12px 14px 14px; }
    .cartEmpty{ color:var(--muted); font-weight:700; margin:4px 0 10px; }

    .cartList{
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 340px;
      overflow:auto;
      padding-right:6px;
    }
    .cartItem{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      background:#fff;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:8px;
      align-items:start;
    }
    .cartItem .name{ font-weight:1000; }
    .cartItem .meta{ color:var(--muted); font-size:13px; margin-top:2px; }
    .cartItem .right{
      text-align:right;
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:flex-end;
    }
    .miniBtns{
      display:flex;
      gap:6px;
      align-items:center;
    }
    .mini{
      border:1px solid var(--border);
      background:#fff;
      border-radius:10px;
      padding:6px 9px;
      cursor:pointer;
      font-weight:900;
    }
    .mini:hover{ background:#f8fafc; }

    .totals{
      margin-top:12px;
      border-top:1px solid var(--border);
      padding-top:12px;
      display:grid;
      gap:6px;
      font-weight:900;
    }
    .totals .row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:baseline;
    }
    .totals .big{
      font-size:22px;
      color:var(--price);
    }

    .cartBtns{
      margin-top:12px;
      display:grid;
      gap:10px;
    }
    .btnClear{
      background:#fff;
      border:1px solid var(--border);
      color:#0f172a;
    }
    .btnClear:hover{ background:#f8fafc; }

    .btnWA{
      background:#16a34a;
      color:#fff;
      font-size:15px;
    }
    .btnWA:hover{ opacity:.92; }
    .hint{
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
    }

    /* Footer bar */
    footer{
      position:fixed;
      left:0; right:0; bottom:0;
      background:rgba(11,18,32,.98);
      color:#fff;
      padding:10px 12px;
      text-align:center;
      font-weight:800;
      letter-spacing:.2px;
      z-index:60;
    }
    footer a{ color:#93c5fd; text-decoration:none; }
    footer a:hover{ text-decoration:underline; }

    /* Error box */
    .errorBox{
      border:1px solid #fecaca;
      background:#fff1f2;
      color:#7f1d1d;
      border-radius:14px;
      padding:10px 12px;
      font-weight:800;
      margin-top:10px;
      display:none;
    }
    .errorBox.show{ display:block; }
  </style>
</head>

<body>
  <header>
    <div class="brand">
      <h1>Gjekaj Plants ‚Äî Katalogu i Bim√´ve</h1>
      <div class="sub">Daj√ß, Shkod√´r, Albania ¬∑ Tel: <a href="tel:+355697232425">+355697232425</a></div>
    </div>
  </header>

  <main class="wrap">
    <!-- LEFT: filters + products -->
    <section class="panel">
      <div class="inner">
        <div class="filters">
          <div>
            <label for="q">K√´rko (em√´r / kategori / kod)</label>
            <input id="q" placeholder="p.sh. cipresus, 019, dekorative..." autocomplete="off" />
          </div>

          <div>
            <label for="cat">Kategori</label>
            <select id="cat">
              <option value="">T√´ gjitha kategorit√´</option>
            </select>
          </div>

          <div>
            <label for="rate">Kursi ‚Ç¨ ‚Üí Lek</label>
            <input id="rate" inputmode="numeric" value="97" />
          </div>
        </div>

        <div class="metaRow">
          <div><span id="count">0</span> artikuj</div>
          <div class="status" id="status">Duke u lidhur‚Ä¶</div>
        </div>

        <div class="errorBox" id="errBox"></div>
      </div>

      <div class="grid" id="grid"></div>
    </section>

    <!-- RIGHT: cart -->
    <aside class="panel cart">
      <div class="cartHead">
        <h3>Shporta</h3>
        <div class="badge"><span id="cartCount">0</span> produkte</div>
      </div>

      <div class="cartInner">
        <div class="cartEmpty" id="cartEmpty">Shporta √´sht√´ bosh.</div>

        <div class="cartList" id="cartList" style="display:none;"></div>

        <div class="totals">
          <div class="row">
            <div>Totali (Lek)</div>
            <div class="big"><span id="totalLek">0</span> Lek√´</div>
          </div>
          <div class="row">
            <div>Totali (‚Ç¨)</div>
            <div class="big"><span id="totalEur">0.00</span> ‚Ç¨</div>
          </div>
        </div>

        <div style="margin-top:10px;">
          <label for="note">Sh√´nim (opsionale)</label>
          <textarea id="note" placeholder="p.sh. d√´rges√´ / orari / k√´rkesa speciale‚Ä¶"></textarea>
          <div class="hint">Mesazhi do d√´rgohet n√´ WhatsApp me list√´n e produkteve dhe totalin.</div>
        </div>

        <div class="cartBtns">
          <button class="btn btnClear" id="clearBtn">Pastro shport√´n</button>
          <button class="btn btnWA" id="waBtn">D√´rgo n√´ WhatsApp</button>
        </div>
      </div>
    </aside>
  </main>

  <footer>
    Gjekaj Plants ‚Ä¢ WhatsApp: <a href="https://wa.me/355697232425" target="_blank" rel="noreferrer">0697232425</a>
  </footer>

  <!-- Supabase UMD (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <script>
    /*********
     * CONFIG
     *********/
    const SUPABASE_URL = "https://oehcfyfjlwvlqowjezwg.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_Ll_tV3Hs9MmMO54DaDWGiQ_KRpED8xd";
    const TABLE_NAME = "products";

    const WHATSAPP_PHONE = "355697232425"; // pa +, pa hap√´sira

    /*********
     * STATE
     *********/
    let ALL = [];
    let FILTERED = [];
    let CART = loadCart();

    const elQ = document.getElementById("q");
    const elCat = document.getElementById("cat");
    const elRate = document.getElementById("rate");
    const elGrid = document.getElementById("grid");
    const elCount = document.getElementById("count");
    const elStatus = document.getElementById("status");
    const elErrBox = document.getElementById("errBox");

    const elCartCount = document.getElementById("cartCount");
    const elCartEmpty = document.getElementById("cartEmpty");
    const elCartList = document.getElementById("cartList");
    const elTotalLek = document.getElementById("totalLek");
    const elTotalEur = document.getElementById("totalEur");
    const elNote = document.getElementById("note");
    const elClearBtn = document.getElementById("clearBtn");
    const elWaBtn = document.getElementById("waBtn");

    /*********
     * HELPERS
     *********/
    function showError(msg){
      elErrBox.textContent = msg;
      elErrBox.classList.add("show");
      elStatus.textContent = "Gabim";
      elStatus.classList.remove("ok");
      elStatus.classList.add("err");
    }
    function clearError(){
      elErrBox.textContent = "";
      elErrBox.classList.remove("show");
      elStatus.classList.remove("err");
    }

    function norm(str){
      return (str ?? "").toString().trim().toLowerCase();
    }

    function toInt(x){
      const n = Number(String(x).replace(",", "."));
      return Number.isFinite(n) ? n : 0;
    }

    function euroFromLek(lek, rate){
      const r = Math.max(1, toInt(rate));
      return lek / r;
    }

    function fmtEur(x){
      const n = Number(x);
      if (!Number.isFinite(n)) return "0.00";
      return n.toFixed(2);
    }

    function safeText(s){
      return (s ?? "").toString();
    }

    function escapeHtml(s){
      return safeText(s).replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[c]));
    }

    function loadCart(){
      try{
        const raw = localStorage.getItem("gjekaj_cart_v1");
        return raw ? JSON.parse(raw) : {};
      }catch(e){
        return {};
      }
    }
    function saveCart(){
      localStorage.setItem("gjekaj_cart_v1", JSON.stringify(CART));
    }

    function cartItems(){
      // CART: { code: {code,name,price_lek,qty} }
      return Object.values(CART || {});
    }

    function cartTotals(){
      const rate = toInt(elRate.value);
      let lek = 0;
      let qty = 0;
      for (const it of cartItems()){
        qty += toInt(it.qty);
        lek += toInt(it.price_lek) * toInt(it.qty);
      }
      return { lek, eur: euroFromLek(lek, rate), qty };
    }

    /*********
     * RENDER: PRODUCTS
     *********/
    function buildCategories(rows){
      const set = new Set();
      for (const r of rows){
        const c = safeText(r.category).trim();
        if (c) set.add(c);
      }
      const cats = Array.from(set).sort((a,b)=>a.localeCompare(b));
      // keep current selection
      const current = elCat.value;
      elCat.innerHTML = <option value="">T√´ gjitha kategorit√´</option> +
        cats.map(c => <option value="${escapeHtml(c)}">${escapeHtml(c)}</option>).join("");
      // restore if exists
      if (current && cats.includes(current)) elCat.value = current;
    }

    function applyFilters(){
      const q = norm(elQ.value);
      const cat = safeText(elCat.value).trim();

      FILTERED = ALL.filter(r => {
        if (cat && safeText(r.category).trim() !== cat) return false;

        if (!q) return true;

        const hay = [
          r.name, r.category, r.code, r.description
        ].map(norm).join(" | ");

        return hay.includes(q);
      });

      elCount.textContent = String(FILTERED.length);
      renderProducts();
    }

    function renderProducts(){
      const rate = toInt(elRate.value);

      if (!FILTERED.length){
        elGrid.innerHTML = "";
        return;
      }

      elGrid.innerHTML = FILTERED.map(r => {
        const name = safeText(r.name);
        const category = safeText(r.category);
        const code = safeText(r.code);
        const stock = toInt(r.stock);
        const priceLek = toInt(r.price_lek);
        const desc = safeText(r.description);
        const photo = safeText(r.photo_url);

        const eur = euroFromLek(priceLek, rate);

        const imgHtml = photo
          ? <img class="pimg" src="${escapeHtml(photo)}" alt="${escapeHtml(name)}" loading="lazy" />
          : <div class="pimg"></div>;

        return `
          <article class="product">
            ${imgHtml}
            <div class="pbody">
              <h2 class="ptitle">${escapeHtml(name || "(pa em√´r)")}</h2>

              <div class="details">
                <div><b>Kategoria:</b> ${escapeHtml(category || "-")}</div>
                <div><b>Kodi:</b> ${escapeHtml(code || "-")}</div>
                <div><b>Stok:</b> ${escapeHtml(String(stock))}</div>
              </div>

              <div class="priceRow">
                <div class="lek">${escapeHtml(String(priceLek))} Lek√´</div>
                <div class="eur">${escapeHtml(fmtEur(eur))} ‚Ç¨</div>
              </div>

              <div class="desc">${escapeHtml(desc)}</div>

              <div class="actions">
                <input class="qty" type="number" min="1" value="1" id="qty_${escapeHtml(code)}" />
                <button class="btn btnAdd" onclick="window.__addByCode('${escapeHtml(code)}')">Shto n√´ shport√´</button>
              </div>
            </div>
          </article>
        `;
      }).join("");
    }

    /*********
     * CART OPS
     *********/
    function addToCartByCode(code){
      const row = ALL.find(r => safeText(r.code) === code);
      if (!row) return;

      const qtyEl = document.getElementById("qty_" + code);
      const qty = Math.max(1, toInt(qtyEl ? qtyEl.value : 1));

      const key = safeText(row.code);
      if (!key) return;

      if (!CART[key]){
        CART[key] = {
          code: key,
          name: safeText(row.name),
          category: safeText(row.category),
          price_lek: toInt(row.price_lek),
          qty: 0
        };
      }
      CART[key].qty += qty;

      saveCart();
      renderCart();
    }

    function inc(code){
      if (!CART[code]) return;
      CART[code].qty += 1;
      saveCart();
      renderCart();
    }
    function dec(code){
      if (!CART[code]) return;
      CART[code].qty -= 1;
      if (CART[code].qty <= 0) delete CART[code];
      saveCart();
      renderCart();
    }
    function remove(code){
      if (!CART[code]) return;
      delete CART[code];
      saveCart();
      renderCart();
    }
    function clearCart(){
      CART = {};
      saveCart();
      renderCart();
    }

    function renderCart(){
      const items = cartItems();
      const totals = cartTotals();

      elCartCount.textContent = String(totals.qty);
      elTotalLek.textContent = String(totals.lek);
      elTotalEur.textContent = fmtEur(totals.eur);

      if (!items.length){
        elCartEmpty.style.display = "block";
        elCartList.style.display = "none";
        elCartList.innerHTML = "";
        return;
      }

      elCartEmpty.style.display = "none";
      elCartList.style.display = "flex";

      elCartList.innerHTML = items.map(it => {
        const lineLek = toInt(it.price_lek) * toInt(it.qty);
        return `
          <div class="cartItem">
            <div>
              <div class="name">${escapeHtml(it.name || it.code)}</div>
              <div class="meta">Kodi: ${escapeHtml(it.code)} ¬∑ Sasia: ${escapeHtml(String(it.qty))}</div>
              <div class="meta" style="margin-top:4px;">
                ${escapeHtml(String(lineLek))} Lek√´
              </div>
            </div>
            <div class="right">
              <div class="miniBtns">
                <button class="mini" title="Ul" onclick="window.__dec('${escapeHtml(it.code)}')">‚àí</button>
                <button class="mini" title="Shto" onclick="window.__inc('${escapeHtml(it.code)}')">+</button>
                <button class="mini" title="Hiq" onclick="window.__rm('${escapeHtml(it.code)}')">√ó</button>
              </div>
            </div>
          </div>
        `;
      }).join("");
    }

    function buildWhatsAppMessage(){
      const items = cartItems();
      const totals = cartTotals();
      const rate = toInt(elRate.value);
      const note = safeText(elNote.value).trim();

      let msg = "üìå POROSI ‚Äî Gjekaj Plants\n\n";
      for (const it of items){
        const lineLek = toInt(it.price_lek) * toInt(it.qty);
        msg += ‚Ä¢ ${it.name} (Kodi ${it.code}) ‚Äî ${it.qty} x ${it.price_lek} = ${lineLek} Lek√´\n;
      }
      msg += \nTotali: ${totals.lek} Lek√´ (~${fmtEur(totals.eur)} ‚Ç¨)\n;
      msg += Kursi: 1‚Ç¨ = ${rate} Lek\n;
      if (note) msg += \nSh√´nim: ${note}\n;
      msg += "\nFaleminderit!";

      return msg;
    }

    function sendWhatsApp(){
      const items = cartItems();
      if (!items.length){
        alert("Shporta √´sht√´ bosh. Shto produkte para se ta d√´rgosh.");
        return;
      }
      const text = encodeURIComponent(buildWhatsAppMessage());
      const url = https://wa.me/${WHATSAPP_PHONE}?text=${text};
      window.open(url, "_blank");
    }

    /*********
     * LOAD DATA (Supabase)
     *********/
    async function load(){
      clearError();
      elStatus.textContent = "Duke u lidhur‚Ä¶";
      elStatus.classList.remove("ok");
      elStatus.classList.remove("err");

      // kontrollo librarin√´ supabase
      if (!window.supabase || !window.supabase.createClient){
        showError("Supabase library nuk u ngarkua. Kontrollo internetin ose bllokues (adblock).");
        return;
      }

      // kontrollo URL + KEY
      if (!SUPABASE_URL.includes("supabase.co") || !SUPABASE_ANON_KEY.startsWith("sb_")){
        showError("Mungon SUPABASE_URL ose SUPABASE_ANON_KEY (publishable).");
        return;
      }

      try{
        const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const { data, error } = await client
          .from(TABLE_NAME)
          .select("name, category, code, stock, price_lek, description, photo_url")
          .order("code", { ascending: true });

        if (error) throw error;

        ALL = Array.isArray(data) ? data : [];
        buildCategories(ALL);
        applyFilters();

        elStatus.textContent = "Gati.";
        elStatus.classList.add("ok");
      }catch(e){
        console.error("Supabase fetch error:", e);
        showError("Nuk po merr t√´ dh√´na nga Supabase. Kontrollo: RLS policy (SELECT p√´r anon), emrin e tabel√´s 'products', dhe kolonat.");
      }
    }

    /*********
     * EVENTS
     *********/
    elQ.addEventListener("input", () => applyFilters());
    elCat.addEventListener("change", () => applyFilters());
    elRate.addEventListener("input", () => {
      // re-render prices + totals
      renderProducts();
      renderCart();
    });

    elClearBtn.addEventListener("click", () => clearCart());
    elWaBtn.addEventListener("click", () => sendWhatsApp());

    // globals for onclick
    window.__addByCode = addToCartByCode;
    window.__inc = inc;
    window.__dec = dec;
    window.__rm = remove;

    // init
    renderCart();
    load();
  </script>
</body>
</html>
