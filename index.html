<!doctype html>
<html lang="sq">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gjekaj Plants â€” Katalogu i BimÃ«ve</title>

  <style>
    :root{
      --bg:#f3f5f8; --card:#fff; --text:#0f172a; --muted:#64748b;
      --border:#e5e7eb; --accent:#b91c1c; --dark:#111827;
      --radius:14px;
    }
    body{margin:0;font-family:Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{background:var(--dark);color:#fff;padding:18px;text-align:center}
    .wrap{max-width:1200px;margin:16px auto 90px;padding:0 12px}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    .col{flex:1;min-width:220px}
    label{display:block;font-size:12px;font-weight:800;color:var(--muted);margin:0 0 6px}
    input,select{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;font-size:14px}
    .status{margin-top:10px;font-weight:bold;color:var(--muted)}
    .error{margin-top:10px;background:#fee2e2;border:1px solid #fecaca;border-left:6px solid var(--accent);
      color:#7f1d1d;border-radius:12px;padding:10px;display:none;white-space:pre-wrap}

    .cards{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin-top:14px}
    @media(max-width:900px){.cards{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(max-width:600px){.cards{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
    .img{width:100%;height:200px;background:#e5e7eb;display:block;object-fit:cover}
    .c{padding:12px}
    .name{font-size:18px;font-weight:bold;margin:0 0 6px}
    .meta{color:var(--muted);font-size:13px;line-height:1.35}
    .price{margin-top:8px;display:flex;gap:10px;align-items:baseline;flex-wrap:wrap}
    .lek{font-size:20px;font-weight:900;color:var(--accent)}
    .eur{font-size:14px;font-weight:800;color:#334155}

    .buy{margin-top:10px;display:flex;gap:10px;align-items:center}
    .qty{width:90px}
    .btn{flex:1;padding:10px;border:0;border-radius:10px;background:var(--dark);color:#fff;font-weight:800;cursor:pointer}

    /* CART */
    .cart{
      position:fixed; right:12px; bottom:12px; width:320px; max-width: calc(100vw - 24px);
      background:var(--dark); color:#fff; border-radius:16px; padding:12px;
      box-shadow:0 18px 50px rgba(2,6,23,.22); border:1px solid rgba(255,255,255,.08);
    }
    .cart h3{margin:0 0 8px;font-size:16px}
    .cartSmall{opacity:.85;font-size:12px;font-weight:700;margin:0 0 10px}
    .cartList{display:flex;flex-direction:column;gap:10px;max-height:40vh;overflow:auto}
    .cartItem{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:10px}
    .cartItem .t{font-weight:900;font-size:13px}
    .cartItem .s{opacity:.9;font-size:12px;margin-top:4px}
    .cartItem .row2{display:flex;gap:8px;margin-top:8px}
    .cartItem input{width:70px;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.10);color:#fff;font-weight:900}
    .del{flex:1;border:0;border-radius:10px;padding:8px;background:rgba(244,63,94,.22);color:#fff;font-weight:900;cursor:pointer}

    .tot{margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,.12);display:flex;justify-content:space-between;gap:10px;align-items:baseline}
    .tot .big{font-size:18px;font-weight:1000}
    .tot .small{font-size:13px;font-weight:900;opacity:.95}
    .cartActions{display:flex;gap:10px;margin-top:10px}
    .clear{flex:1;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.08);color:#fff;border-radius:12px;padding:10px;font-weight:900;cursor:pointer}
    .wa{flex:1;border:0;background:#16a34a;color:#fff;border-radius:12px;padding:10px;font-weight:1000;cursor:pointer}
    .wa:disabled{opacity:.55;cursor:not-allowed}
  </style>
</head>

<body>
  <header>
    <h2 style="margin:0">Gjekaj Plants â€” Katalogu i BimÃ«ve</h2>
    <div style="opacity:.9;margin-top:6px;font-size:13px">DajÃ§, ShkodÃ«r â€¢ Tel: +355697232425</div>
  </header>

  <div class="wrap">
    <div class="panel">
      <div class="row">
        <div class="col">
          <label>KÃ«rko (emÃ«r / kategori / kod)</label>
          <input id="q" placeholder="p.sh. cipresus, 019, dekorative..." />
        </div>

        <div class="col">
          <label>Kategori</label>
          <select id="cat">
            <option value="">TÃ« gjitha kategoritÃ«</option>
          </select>
        </div>

        <div class="col" style="max-width:240px">
          <label>Kursi â‚¬ â†’ Lek (1â‚¬ = ?)</label>
          <input id="rate" type="number" min="1" step="1" value="97" />
        </div>
      </div>

      <div id="status" class="status">Duke u lidhur me Supabaseâ€¦</div>
      <div id="err" class="error"></div>
    </div>

    <div id="cards" class="cards"></div>
  </div>

  <!-- CART -->
  <div class="cart">
    <h3>Shporta</h3>
    <div class="cartSmall" id="cartCount">0 artikuj</div>
    <div class="cartList" id="cartItems">Bosh.</div>

    <div class="tot">
      <div class="big" id="totalLek">0 LekÃ«</div>
      <div class="small" id="totalEur">0.00 â‚¬</div>
    </div>

    <div class="cartActions">
      <button class="clear" id="clearCart" type="button">Pastro</button>
      <button class="wa" id="sendWA" type="button" disabled>DÃ«rgo WA</button>
    </div>
  </div>

<script>
  // âœ… SUPABASE SETTINGS (ngjit Ã§elÃ«sin tÃ«nd kÃ«tu)
  var SUPABASE_URL = "https://oehcfyfjlwvlqowjezwg.supabase.co";
  var SUPABASE_ANON_KEY = "VENDOS_ANON_KEY_KETU";
  var TABLE = "products";

  // âœ… WhatsApp (pa +)
  var WHATSAPP_NUMBER = "355697232425";

  var ALL = [];
  var CART = {}; // { id: {row, qty} }

  var elQ = document.getElementById("q");
  var elCat = document.getElementById("cat");
  var elRate = document.getElementById("rate");
  var elCards = document.getElementById("cards");
  var elStatus = document.getElementById("status");
  var elErr = document.getElementById("err");

  var cartItems = document.getElementById("cartItems");
  var cartCount = document.getElementById("cartCount");
  var totalLek = document.getElementById("totalLek");
  var totalEur = document.getElementById("totalEur");
  var clearCartBtn = document.getElementById("clearCart");
  var sendWABtn = document.getElementById("sendWA");

  function showError(msg){ elErr.style.display="block"; elErr.textContent=msg; }
  function clearError(){ elErr.style.display="none"; elErr.textContent=""; }

  function esc(s){
    s = (s===null || s===undefined) ? "" : String(s);
    return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
  }

  function toNum(v){
    if(v===null||v===undefined) return 0;
    var s = String(v).replace(/\./g,"").replace(",",".").replace(/[^\d.]/g,"");
    var n = Number(s);
    return isFinite(n) ? n : 0;
  }

  function fmtLek(n){
    n = Math.round(n);
    return String(n).replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }

  function getImg(p){
    // provo disa emra kolone tipike
    return p.photo_url || p.image_url || p.img_url || p.photo || p.image || p.foto || p.url_photo || p.url_image || "";
  }

  function buildCategories(rows){
    var map = {};
    for(var i=0;i<rows.length;i++){
      var c = rows[i] && rows[i].category ? String(rows[i].category).trim() : "";
      if(c) map[c]=true;
    }
    var cats = [];
    for(var k in map) cats.push(k);
    cats.sort();

    var current = elCat.value;
    var html = '<option value="">TÃ« gjitha kategoritÃ«</option>';
    for(var j=0;j<cats.length;j++){
      html += '<option value="'+esc(cats[j])+'">'+esc(cats[j])+'</option>';
    }
    elCat.innerHTML = html;
    if(current) elCat.value = current;
  }

  function render(){
    clearError();
    var q = (elQ.value||"").toLowerCase().trim();
    var cat = (elCat.value||"").trim();
    var rate = Math.max(1, toNum(elRate.value||97));

    var out = [];
    for(var i=0;i<ALL.length;i++){
      var r = ALL[i] || {};
      var name = r.name ? String(r.name) : "";
      var category = r.category ? String(r.category) : "";
      var code = r.code ? String(r.code) : "";

      if(cat && category !== cat) continue;
      if(q){
        var hay = (name+" "+category+" "+code).toLowerCase();
        if(hay.indexOf(q) === -1) continue;
      }
      out.push(r);
    }

    var html = "";
    for(var j=0;j<out.length;j++){
      var p = out[j] || {};
      var img = getImg(p);
      var lek = toNum(p.price_lek || 0);
      var eur = lek / rate;

      html += '<div class="card">'
        + (img ? '<img class="img" src="'+esc(img)+'" alt="'+esc(p.name||"")+'" loading="lazy" onerror="this.style.display=\'none\';" />' : '')
        + '<div class="c">'
        +   '<p class="name">'+esc(p.name || "(pa emÃ«r)")+'</p>'
        +   '<div class="meta">'
        +     (p.category ? ('Kategoria: <b>'+esc(p.category)+'</b><br>') : '')
        +     (p.code ? ('Kodi: <b>'+esc(p.code)+'</b><br>') : '')
        +     (p.stock!==undefined && p.stock!==null ? ('Stok: <b>'+esc(p.stock)+'</b>') : '')
        +   '</div>'
        +   '<div class="price"><span class="lek">'+fmtLek(lek)+' LekÃ«</span> <span class="eur">('+eur.toFixed(2)+' â‚¬)</span></div>'
        +   '<div class="buy">'
        +     '<input class="qty" type="number" min="1" step="1" value="1" id="qty_'+p.id+'">'
        +     '<button class="btn" type="button" onclick="addToCart('+p.id+')">Shto nÃ« shportÃ«</button>'
        +   '</div>'
        + '</div>'
        + '</div>';
    }

    elCards.innerHTML = html || "<div style='padding:12px;color:#64748b;font-weight:bold'>Nuk ka produkte pÃ«r kÃ«tÃ« filtÃ«r.</div>";
    elStatus.textContent = "Gati. (" + out.length + " artikuj)";
  }

  function saveCart(){
    try{ localStorage.setItem("gjekaj_cart", JSON.stringify(CART)); }catch(e){}
  }
  function loadCart(){
    try{
      var raw = localStorage.getItem("gjekaj_cart");
      if(raw) CART = JSON.parse(raw) || {};
    }catch(e){ CART = {}; }
  }

  function cartTotals(){
    var rate = Math.max(1, toNum(elRate.value||97));
    var sum = 0;
    var count = 0;
    for(var id in CART){
      var it = CART[id];
      var lek = toNum(it.row.price_lek||0);
      var qty = Math.max(1, toNum(it.qty||1));
      sum += lek * qty;
      count += qty;
    }
    cartCount.textContent = count + " artikuj";
    totalLek.textContent = fmtLek(sum) + " LekÃ«";
    totalEur.textContent = (sum / rate).toFixed(2) + " â‚¬";
    sendWABtn.disabled = sum <= 0;
    saveCart();
    return {sum:sum, rate:rate};
  }

  function renderCart(){
    var ids = [];
    for(var id in CART) ids.push(id);

    if(ids.length === 0){
      cartItems.innerHTML = "Bosh.";
      cartTotals();
      return;
    }

    var html = "";
    for(var i=0;i<ids.length;i++){
      var id = ids[i];
      var it = CART[id];
      var p = it.row || {};
      var qty = Math.max(1, toNum(it.qty||1));
      var lek = toNum(p.price_lek||0);

      html += '<div class="cartItem">'
        + '<div class="t">'+esc(p.name||"(pa emÃ«r)")+'</div>'
        + '<div class="s">'+(p.code?('Kodi: <b>'+esc(p.code)+'</b><br>'):'')+'Ã‡mimi: <b>'+fmtLek(lek)+' LekÃ«</b></div>'
        + '<div class="row2">'
        +   '<input type="number" min="1" step="1" value="'+qty+'" oninput="setQty(\''+esc(id)+'\', this.value)">'
        +   '<button class="del" type="button" onclick="removeItem(\''+esc(id)+'\')">Hiq</button>'
        + '</div>'
        + '</div>';
    }

    cartItems.innerHTML = html;
    cartTotals();
  }

  // kÃ«to funksione duhen globale pÃ«r onclick
  window.addToCart = function(pid){
    var row = null;
    for(var i=0;i<ALL.length;i++){
      if(String(ALL[i].id) === String(pid)){ row = ALL[i]; break; }
    }
    if(!row) return;

    var qtyEl = document.getElementById("qty_"+pid);
    var q = Math.max(1, toNum(qtyEl ? qtyEl.value : 1));

    var id = String(row.id);
    if(!CART[id]) CART[id] = { row: row, qty: q };
    else CART[id].qty = Math.max(1, toNum(CART[id].qty||1) + q);

    renderCart();
  };

  window.setQty = function(id, v){
    if(!CART[id]) return;
    CART[id].qty = Math.max(1, toNum(v||1));
    renderCart();
  };

  window.removeItem = function(id){
    delete CART[id];
    renderCart();
  };

  function buildWhatsAppText(){
    var t = cartTotals();
    var lines = [];
    lines.push("ðŸ“Œ KÃ«rkesÃ« nga Katalogu â€” Gjekaj Plants");
    lines.push("");

    for(var id in CART){
      var it = CART[id];
      var p = it.row || {};
      var qty = Math.max(1, toNum(it.qty||1));
      var lek = toNum(p.price_lek||0);
      lines.push("â€¢ "+(p.name||"(pa emÃ«r)")+(p.code?(" (Kodi: "+p.code+")"):""));
      lines.push("  Sasia: "+qty+" | NÃ«n-total: "+fmtLek(lek*qty)+" LekÃ«");
    }

    lines.push("");
    lines.push("Totali: "+fmtLek(t.sum)+" LekÃ«");
    lines.push("Kursi: 1â‚¬ = "+t.rate+" Lek");
    return lines.join("\n");
  }

  clearCartBtn.addEventListener("click", function(){
    if(!confirm("Me e pastru shportÃ«n komplet?")) return;
    CART = {};
    renderCart();
  });

  sendWABtn.addEventListener("click", function(){
    var msg = buildWhatsAppText();
    var url = "https://wa.me/"+WHATSAPP_NUMBER+"?text="+encodeURIComponent(msg);
    window.open(url, "_blank");
  });

  function loadProducts(){
    clearError();
    elStatus.textContent = "Duke u lidhur me Supabaseâ€¦";

    var url = SUPABASE_URL + "/rest/v1/" + TABLE + "?select=*";
    var xhr = new XMLHttpRequest();
    xhr.open("GET", url, true);
    xhr.setRequestHeader("apikey", SUPABASE_ANON_KEY);
    xhr.setRequestHeader("Authorization", "Bearer " + SUPABASE_ANON_KEY);
    xhr.setRequestHeader("Accept", "application/json");

    xhr.onreadystatechange = function(){
      if(xhr.readyState !== 4) return;

      if(xhr.status >= 200 && xhr.status < 300){
        try{ ALL = JSON.parse(xhr.responseText) || []; }
        catch(e){
          showError("Gabim te JSON: " + e);
          elStatus.textContent = "Gabim";
          return;
        }
        buildCategories(ALL);
        render();
        return;
      }

      showError("Gabim Supabase ("+xhr.status+").\n\n" + (xhr.responseText || ""));
      elStatus.textContent = "Gabim";
    };

    xhr.onerror = function(){
      showError("Gabim rrjeti. Kontrollo internetin / SSL / bllokime.");
      elStatus.textContent = "Gabim";
    };

    xhr.send();
  }

  // Events
  elQ.oninput = render;
  elCat.onchange = render;
  elRate.oninput = function(){ render(); renderCart(); };

  // Start
  loadCart();
  renderCart();
  loadProducts();
</script>

</body>
</html>
