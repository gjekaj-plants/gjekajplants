<!doctype html>
<html lang="sq">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gjekaj Plants — Katalogu i Bimëve</title>

  <meta name="description" content="Gjekaj Plants — Pemë dekorative, bimë, fidane dhe shkurre. Shiko katalogun, filtro sipas emrit/kategorisë. Porosi online dhe dërgo në WhatsApp +355697232425." />
  <meta name="keywords" content="pemë dekorative, bimë dekorative, fidane, shkurre dekorative, Dajç Shkodër, katalog bimësh, Gjekaj Plants" />
  <meta name="google-site-verification" content="9bmY4UyP5oEu3VLcx3YxR3rDEG9NLXB3CVVJ_g5JsaA" />

  <meta property="og:title" content="Gjekaj Plants — Katalogu i Bimëve Dekorative" />
  <meta property="og:description" content="Pamje e pemëve dekorative dhe bimëve. Zgjidh sasinë dhe dërgo kërkesën në WhatsApp." />
  <meta property="og:type" content="website" />
  <!-- vendose URL e GitHub Pages (sipas screenshot): -->
  <meta property="og:url" content="https://gjekaj-plants.github.io/gjekajplants/" />

  <style>
    :root{
      --bg:#f3f5f8;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;
      --shadow: 0 10px 30px rgba(2,6,23,.08);
      --radius: 18px;
      --accent:#b91c1c;
      --green:#16a34a;
      --offer:#dc2626;
      --dark1:#0b1220;
      --dark2:#111827;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);}

    header{
      background: linear-gradient(180deg, var(--dark1) 0%, var(--dark2) 100%);
      color:#fff;
      padding: 20px 14px 14px;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    header h1{margin:0;font-size:clamp(20px,3.4vw,32px);font-weight:900;line-height:1.1;}
    header .sub{margin-top:6px;opacity:.9;font-size:14px;font-weight:800;}
    header .sub a{color:#93c5fd;text-decoration:none;font-weight:900;}
    header .sub a:hover{text-decoration:underline;}

    .wrap{max-width:1100px;margin:14px auto 90px;padding:0 14px;}

    .error{
      display:none;margin:14px 0 0;background:#fff;border:1px solid #fecaca;
      border-left:6px solid #b91c1c;border-radius:14px;padding:12px 12px;
      font-weight:900;color:#7f1d1d;
    }

    .panel{
      background:var(--card);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      border-radius:var(--radius);
      padding:14px;
      margin-top:14px;
    }

    /* Filtrat + Shporta si te tiiny: në PC 2 kolona, në mobile 1 kolonë */
    .topGrid{
      display:grid;
      grid-template-columns: 1.6fr .9fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width:920px){
      .topGrid{ grid-template-columns:1fr; }
    }

    .grid-controls{
      display:grid;
      grid-template-columns: 1.2fr .8fr .6fr;
      gap:10px;
    }
    @media (max-width:820px){ .grid-controls{grid-template-columns:1fr;} }

    label{font-size:12px;font-weight:900;color:var(--muted);display:block;margin:6px 0 6px;}
    input, select, textarea{
      width:100%;padding:12px 12px;border:1px solid var(--border);border-radius:12px;
      font-size:15px;outline:none;background:#fff;
    }
    input:focus, select:focus, textarea:focus{
      border-color:#93c5fd;box-shadow:0 0 0 4px rgba(59,130,246,.12);
    }

    .bar{display:flex;justify-content:space-between;align-items:center;margin-top:12px;gap:10px;}
    .count,.status{font-size:13px;color:var(--muted);font-weight:900;}

    /* SHPORTA: sticky në PC (në të djathtë), në mobile rri normal poshtë filtrave */
    .cartSticky{
      position: sticky;
      top: 96px;
      z-index: 200;
    }
    @media (max-width:920px){
      .cartSticky{ position: relative; top: auto; }
    }

    .cart{
      background: linear-gradient(180deg, var(--dark1) 0%, var(--dark2) 100%);
      color:#fff;
      border-radius: 18px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.06);
      overflow:hidden;
    }
    .cartHead{padding:14px 14px 10px;font-weight:1000;font-size:20px;}
    .cartBody{padding:0 14px 14px;}
    .cartEmpty{opacity:.9;font-weight:900;margin-bottom:10px;}

    .cartList{
      margin:10px 0 12px;
      display:flex;flex-direction:column;gap:10px;
      max-height: 260px;
      overflow:auto;
      padding-right:4px;
    }
    .cartItem{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding: 10px;
    }
    .ciTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;}
    .ciName{font-weight:1000;line-height:1.15;font-size:14px;}
    .ciMeta{opacity:.9;font-weight:800;font-size:12px;margin-top:6px;line-height:1.3;}
    .ciRight{display:flex;flex-direction:column;gap:8px;align-items:flex-end;min-width:120px;}
    .ciQty{
      width:78px;background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.14);color:#fff;text-align:center;
      font-weight:1000;border-radius:12px;padding:8px 8px;outline:none;
    }
    .ciBtn{
      background: rgba(185,28,28,.9);
      border:0;color:#fff;font-weight:1000;
      padding:8px 10px;border-radius:12px;cursor:pointer;
    }

    .totRow{
      display:flex;justify-content:space-between;gap:10px;align-items:baseline;
      padding:10px 0 8px;border-top:1px solid rgba(255,255,255,.10);
      border-bottom:1px solid rgba(255,255,255,.10);margin:10px 0 10px;
    }
    .totLek{font-weight:1000;font-size:22px;}
    .totEur{font-weight:1000;font-size:16px;opacity:.95;}

    .noteLabel{font-weight:900;opacity:.95;margin:10px 0 6px;font-size:13px;}
    .note{
      width:100%;min-height:70px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      color:#fff;border-radius:14px;padding:10px 10px;resize:vertical;
    }
    .cartActions{display:flex;flex-direction:column;gap:10px;margin-top:10px;}
    .btnGreen{
      background: var(--green);border:0;color:#fff;font-weight:1000;
      padding:12px 14px;border-radius:14px;cursor:pointer;
    }
    .btnGreen[disabled]{opacity:.45;cursor:not-allowed;}
    .btnGray{
      background: rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.14);
      color:#fff;font-weight:1000;padding:12px 14px;border-radius:14px;cursor:pointer;
    }

    .cards{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:14px;
      margin-top:14px;
    }
    @media (max-width:960px){ .cards{grid-template-columns:repeat(2, minmax(0,1fr));} }
    @media (max-width:640px){ .cards{grid-template-columns:1fr;} }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position: relative;
    }
    .img{width:100%;aspect-ratio:16/10;background:#e5e7eb;display:block;object-fit:cover;}
    .content{padding:12px 12px 14px;}
    .name{margin:0;font-size:20px;font-weight:1000;}
    .meta{margin-top:8px;color:var(--muted);font-size:13px;line-height:1.35;font-weight:700;}

    /* Çmimi: i vjetri sipër i prerë, i riu poshtë në të njëjtën madhësi si para */
    .priceWrap{margin-top:10px;}
    .oldRow{
      display:flex;align-items:center;gap:8px;flex-wrap:wrap;
      font-weight:900;color:#64748b;
    }
    .oldPrice{
      text-decoration: line-through;
      text-decoration-thickness: 2px;
      opacity:.95;
    }
    .badge{
      display:inline-flex;align-items:center;justify-content:center;
      padding:6px 10px;border-radius:999px;
      background: var(--offer);
      color:#fff;font-weight:1000;font-size:12px;
    }

    .nowRow{
      display:flex;align-items:baseline;justify-content:space-between;
      gap:10px;flex-wrap:nowrap;
      margin-top:6px;
    }
    .lek{color:var(--accent);font-weight:1000;font-size:26px;white-space:nowrap;}
    .eur{color:var(--offer);font-weight:1000;font-size:22px;white-space:nowrap;} /* € djathtas e madhe e kuqe */
    .offerText{
      margin-top:6px;
      display:flex;justify-content:space-between;align-items:center;
    }
    .offerLabel{
      font-weight:1000;
      color: var(--offer);
      letter-spacing:.2px;
    }

    .desc{margin-top:8px;color:#334155;font-size:13px;line-height:1.35;font-weight:650;opacity:.95;}

    .buyrow{display:flex;gap:10px;margin-top:12px;align-items:center;}
    .qty{width:90px;padding:12px;border:1px solid var(--border);border-radius:12px;font-weight:900;text-align:center;}
    .addbtn{
      flex:1;padding:12px 14px;border-radius:12px;border:0;font-weight:1000;
      background: var(--dark1);color:#fff;cursor:pointer;
    }
    .addbtn:hover{opacity:.92;}
    .addbtn:active{transform:translateY(1px);}

    footer{
      position:fixed;left:0;right:0;bottom:0;background:#111827;color:#fff;
      padding:12px 14px;text-align:center;font-weight:1000;z-index:2000;
    }
  </style>
</head>

<body>
  <header>
    <h1>Gjekaj Plants — Katalogu i Bimëve</h1>
    <div class="sub">
      Dajç, Shkodër, Albania • Tel:
      <a href="tel:+355697232425">+355697232425</a>
    </div>
  </header>

  <div class="wrap">
    <div id="err" class="error"></div>

    <div class="panel">
      <div class="topGrid">
        <!-- MAJTAS: FILTERAT + COUNT/STATUS -->
        <div>
          <div class="grid-controls">
            <div>
              <label>Kërko (emër / kategori / kod)</label>
              <input id="q" placeholder="p.sh. cipresus, 019, dekorative..." />
            </div>

            <div>
              <label>Kategori</label>
              <select id="cat">
                <option value="">Të gjitha kategoritë</option>
              </select>
            </div>

            <div>
              <label>Kursi € → Lek (1€ = 97)</label>
              <input id="rate" type="number" inputmode="numeric" min="1" step="1" value="97" />
            </div>
          </div>

          <div class="bar">
            <div class="count" id="count">0 artikuj</div>
            <div class="status" id="status">Duke u lidhur…</div>
          </div>
        </div>

        <!-- DJATHTAS: SHPORTA (sticky) -->
        <div class="cartSticky">
          <div class="cart">
            <div class="cartHead">Shporta</div>
            <div class="cartBody">
              <div id="cartEmpty" class="cartEmpty">Shporta është bosh.</div>

              <div class="totRow">
                <div class="totLek" id="totLek">0 Lekë</div>
                <div class="totEur" id="totEur">0.00 €</div>
              </div>

              <div class="cartList" id="cartList"></div>

              <div class="noteLabel">Shënim (opsionale)</div>
              <textarea id="note" class="note" placeholder="p.sh. dërgesë / orari / kërkesa speciale..."></textarea>

              <div class="cartActions">
                <button id="btnClear" class="btnGray" type="button">Pastro shportën</button>
                <button id="btnWA" class="btnGreen" type="button" disabled>Dërgo në WhatsApp</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- PRODUKTET -->
    <div class="cards" id="cards"></div>
  </div>

  <footer>Gjekaj Plants • WhatsApp: 0697232425</footer>

  <!-- Supabase JS (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // ✅ Këto janë të tuat (të vendosura)
    const SUPABASE_URL = "https://oehcfyfjlwvlqowjezwg.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_Ll_tV3Hs9MmMO54DaDWGiQ_KRpED8xd";
    const TABLE_NAME = "products";

    // Kolonat ekzistuese (si në tabelën tënde)
    const COL_CATEGORY = "category";
    const COL_CODE     = "code";
    const COL_STOCK    = "stock";
    const COL_PRICELEK = "price_lek";

    // ✅ Për OFERTË / çmimi i vjetër / -%  (opsionale në Supabase)
    // Nëse i shton këto kolona, funksionon automatikisht:
    // - price_old_lek (ose old_price_lek)  -> çmimi i vjetër
    // - discount_percent (ose sale_percent) -> p.sh 20
    // - offer_text (ose offer) -> p.sh "OFERTË"
    const COL_OLD1 = "price_old_lek";
    const COL_OLD2 = "old_price_lek";
    const COL_DISC1 = "discount_percent";
    const COL_DISC2 = "sale_percent";
    const COL_OFFER1 = "offer_text";
    const COL_OFFER2 = "offer";

    const NAME_KEYS = ["name","title","emri"];
    const DESC_KEYS = ["description","desc","pershkrimi","pershkrim"];
    const IMG_KEYS  = ["photo_url","image_url","img_url","photo","image","foto","url_photo","url_image"];

    const WA_NUMBER  = "355697232425";

    const elErr = document.getElementById("err");
    const elCards = document.getElementById("cards");
    const elCount = document.getElementById("count");
    const elStatus = document.getElementById("status");
    const elQ = document.getElementById("q");
    const elCat = document.getElementById("cat");
    const elRate = document.getElementById("rate");

    const elCartEmpty = document.getElementById("cartEmpty");
    const elCartList = document.getElementById("cartList");
    const elTotLek = document.getElementById("totLek");
    const elTotEur = document.getElementById("totEur");
    const elNote = document.getElementById("note");
    const btnWA = document.getElementById("btnWA");
    const btnClear = document.getElementById("btnClear");

    function showError(msg){ elErr.style.display="block"; elErr.textContent=msg; }
    function clearError(){ elErr.style.display="none"; elErr.textContent=""; }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function firstExisting(row, keys){
      for (const k of keys){
        if (row && row[k] !== undefined && row[k] !== null && String(row[k]).trim() !== "") return row[k];
      }
      return "";
    }

    function toNumber(v){
      if (v === null || v === undefined) return 0;
      const s = String(v).replaceAll(".", "").replaceAll(",", ".").replace(/[^\d.]/g, "");
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    }

    function formatLek(n){
      const x = Math.round(n);
      return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }
    function formatEuro(n){
      return (Math.round(n * 100) / 100).toFixed(2);
    }

    function getOldPrice(row){
      const a = toNumber(row?.[COL_OLD1]);
      const b = toNumber(row?.[COL_OLD2]);
      return a || b || 0;
    }
    function getDiscountPercent(row, oldLek, newLek){
      const d1 = toNumber(row?.[COL_DISC1]);
      const d2 = toNumber(row?.[COL_DISC2]);
      const direct = d1 || d2 || 0;
      if (direct > 0) return Math.round(direct);
      if (oldLek > 0 && newLek > 0 && oldLek > newLek){
        return Math.round((1 - (newLek/oldLek)) * 100);
      }
      return 0;
    }
    function getOfferText(row, hasDiscount){
      const t = (row?.[COL_OFFER1] ?? row?.[COL_OFFER2] ?? "").toString().trim();
      if (t) return t;
      return hasDiscount ? "OFERTË" : "";
    }

    let ALL = [];
    const CART = {};
    let supabaseClient = null;
    let realtimeSubscribed = false;
    let lastReloadAt = 0;

    function buildCategories(rows){
      const set = new Set();
      for (const r of rows){
        const c = (r?.[COL_CATEGORY] ?? "").toString().trim();
        if (c) set.add(c);
      }
      const cats = Array.from(set).sort((a,b)=>a.localeCompare(b));
      const current = elCat.value;
      elCat.innerHTML = <option value="">Të gjitha kategoritë</option> + cats.map(c => <option value="${escapeHtml(c)}">${escapeHtml(c)}</option>).join("");
      if (cats.includes(current)) elCat.value = current;
    }

    function cartTotalLek(){
      return Object.values(CART).reduce((s,it)=> s + (it.priceLek * it.qty), 0);
    }

    function renderCart(){
      const rate = Math.max(1, toNumber(elRate.value || 100));
      const items = Object.values(CART);

      const totalLek = cartTotalLek();
      const totalEur = totalLek / rate;

      elTotLek.textContent = ${formatLek(totalLek)} Lekë;
      elTotEur.textContent = ${formatEuro(totalEur)} €;

      if (items.length === 0){
        elCartEmpty.style.display = "block";
        elCartList.innerHTML = "";
        btnWA.disabled = true;
        return;
      }

      elCartEmpty.style.display = "none";
      btnWA.disabled = false;

      elCartList.innerHTML = items.map(it => {
        const subLek = it.priceLek * it.qty;
        const subEur = subLek / rate;

        return `
          <div class="cartItem">
            <div class="ciTop">
              <div>
                <div class="ciName">${escapeHtml(it.name)}</div>
                <div class="ciMeta">
                  ${it.category ? Kategoria: <b>${escapeHtml(it.category)}</b><br> : ``}
                  Kodi: <b>${escapeHtml(it.code)}</b><br>
                  Çmimi: <b>${formatLek(it.priceLek)} Lekë</b> (${formatEuro(it.priceLek / rate)} €)<br>
                  Nën-total: <b>${formatLek(subLek)} Lekë</b> (${formatEuro(subEur)} €)
                </div>
              </div>
              <div class="ciRight">
                <input class="ciQty" type="number" min="1" step="1" value="${it.qty}"
                  onchange="window.__setCartQty('${escapeHtml(it.code)}', this.value)" />
                <button class="ciBtn" type="button" onclick="window.__removeCart('${escapeHtml(it.code)}')">Hiq</button>
              </div>
            </div>
          </div>
        `;
      }).join("");
    }

    function setCartQty(code, qty){
      qty = Math.max(0, Math.floor(toNumber(qty)));
      if (!CART[code]) return;
      if (qty === 0) delete CART[code];
      else CART[code].qty = qty;
      renderCart();
    }
    window.__setCartQty = (code, qty) => setCartQty(code, qty);
    window.__removeCart = (code) => { delete CART[String(code)]; renderCart(); };

    function addToCart(item, qty){
      qty = Math.max(1, Math.floor(toNumber(qty)));
      const code = String(item?.[COL_CODE] ?? item.code ?? item.id ?? "").trim() || ("ID" + Math.random());
      const name = firstExisting(item, NAME_KEYS) || "(pa emër)";
      const category = (item?.[COL_CATEGORY] ?? "").toString();
      const priceLek = toNumber(item?.[COL_PRICELEK]);

      if (!CART[code]) CART[code] = { code, name, category, priceLek, qty };
      else CART[code].qty += qty;

      renderCart();
    }

    function clearCart(){
      for (const k of Object.keys(CART)) delete CART[k];
      renderCart();
    }

    function buildWhatsAppMessage(){
      const rate = Math.max(1, toNumber(elRate.value || 100));
      const items = Object.values(CART);
      const totalLek = cartTotalLek();
      const totalEur = totalLek / rate;

      const lines = [];
      lines.push("Përshëndetje, dua të porosis:");
      lines.push("");

      for (const it of items){
        const subLek = it.priceLek * it.qty;
        const subEur = subLek / rate;
        lines.push(• ${it.name} (Kodi: ${it.code}));
        if (it.category) lines.push(`  Kategoria: ${it.category}`);
        lines.push(`  Sasia: ${it.qty}`);
        lines.push(`  Çmimi: ${formatLek(it.priceLek)} Lekë (${formatEuro(it.priceLek / rate)} €)`);
        lines.push(`  Nën-total: ${formatLek(subLek)} Lekë (${formatEuro(subEur)} €)`);
        lines.push("");
      }

      lines.push(TOTALI: ${formatLek(totalLek)} Lekë (${formatEuro(totalEur)} €));
      lines.push(Kursi: 1€ = ${rate} Lek);

      const note = (elNote.value || "").trim();
      if (note){
        lines.push("");
        lines.push("Shënim:");
        lines.push(note);
      }
      return lines.join("\n");
    }

    function sendToWhatsApp(){
      const items = Object.values(CART);
      if (items.length === 0) return;
      const text = buildWhatsAppMessage();
      const url = https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(text)};
      window.open(url, "_blank");
    }

    btnWA.addEventListener("click", sendToWhatsApp);
    btnClear.addEventListener("click", clearCart);

    function render(){
      clearError();

      const q = elQ.value.trim().toLowerCase();
      const cat = elCat.value.trim();
      const rate = Math.max(1, toNumber(elRate.value || 100));

      let filtered = ALL.filter(r => {
        if (cat && String(r?.[COL_CATEGORY] ?? "").trim() !== cat) return false;
        if (!q) return true;
        const name = firstExisting(r, NAME_KEYS).toString().toLowerCase();
        const category = (r?.[COL_CATEGORY] ?? "").toString().toLowerCase();
        const code = (r?.[COL_CODE] ?? "").toString().toLowerCase();
        return name.includes(q) || category.includes(q) || code.includes(q);
      });

      // ✅ Renditje: ofertat në krye
      filtered.sort((a,b) => {
        const aNew = toNumber(a?.[COL_PRICELEK]);
        const bNew = toNumber(b?.[COL_PRICELEK]);
        const aOld = getOldPrice(a);
        const bOld = getOldPrice(b);
        const aDisc = getDiscountPercent(a, aOld, aNew);
        const bDisc = getDiscountPercent(b, bOld, bNew);

        const aHas = (aDisc > 0) || (aOld > aNew && aOld > 0);
        const bHas = (bDisc > 0) || (bOld > bNew && bOld > 0);

        if (aHas !== bHas) return aHas ? -1 : 1;         // oferta lart
        if (bDisc !== aDisc) return bDisc - aDisc;       // % më i madh lart
        const an = firstExisting(a, NAME_KEYS).toString();
        const bn = firstExisting(b, NAME_KEYS).toString();
        return an.localeCompare(bn);
      });

      elCount.textContent = ${filtered.length} artikuj;

      elCards.innerHTML = filtered.map(r => {
        const name = firstExisting(r, NAME_KEYS) || "(pa emër)";
        const desc = firstExisting(r, DESC_KEYS) || "";
        const img = firstExisting(r, IMG_KEYS) || "";
        const category = (r?.[COL_CATEGORY] ?? "").toString();
        const code = (r?.[COL_CODE] ?? "").toString();
        const stock = (r?.[COL_STOCK] ?? "").toString();

        const priceLek = toNumber(r?.[COL_PRICELEK]);
        const priceEur = priceLek / rate;

        const oldLek = getOldPrice(r);
        const disc = getDiscountPercent(r, oldLek, priceLek);
        const hasDiscount = (disc > 0) || (oldLek > priceLek && oldLek > 0);
        const offerText = getOfferText(r, hasDiscount);

        const safeId = q_${escapeHtml(code || String(r.id || Math.random()).replaceAll('.','_'))};

        const imgTag = img
          ? `<img class="img" src="${escapeHtml(img)}" alt="${escapeHtml(name)}" loading="lazy"
              onerror="this.style.display='none'; this.parentNode.style.background='#e5e7eb';" />`
          : <div class="img" style="background:#e5e7eb;"></div>;

        const oldRow = hasDiscount && oldLek > 0
          ? `<div class="oldRow">
               <span class="oldPrice">${formatLek(oldLek)} Lekë</span>
               ${disc > 0 ? <span class="badge">-${disc}%</span> : ``}
             </div>`
          : (hasDiscount && disc > 0 ? <div class="oldRow"><span class="badge">-${disc}%</span></div> : ``);

        const offerLine = hasDiscount
          ? `<div class="offerText">
               <div class="offerLabel">${escapeHtml(offerText || "OFERTË")}</div>
               <div></div>
             </div>`
          : ``;

        return `
          <article class="card">
            ${imgTag}
            <div class="content">
              <h3 class="name">${escapeHtml(name)}</h3>
              <div class="meta">
                ${category ? Kategoria: <b>${escapeHtml(category)}</b><br> : ``}
                ${code ? Kodi: <b>${escapeHtml(code)}</b><br> : ``}
                ${stock ? Stok: <b>${escapeHtml(stock)}</b> : ``}
              </div>

              <div class="priceWrap">
                ${oldRow}
                <div class="nowRow">
                  <div class="lek">${formatLek(priceLek)} Lekë</div>
                  <div class="eur">${formatEuro(priceEur)} €</div>
                </div>
                ${offerLine}
              </div>

              ${desc ? <div class="desc">${escapeHtml(desc)}</div> : ``}

              <div class="buyrow">
                <input class="qty" id="${safeId}" type="number" min="1" step="1" value="1" />
                <button class="addbtn" type="button"
                  onclick="window.__addByRow(${escapeHtml(JSON.stringify(r))}, document.getElementById('${safeId}').value)">
                  Shto në shportë
                </button>
              </div>
            </div>
          </article>
        `;
      }).join("");

      renderCart();
    }

    window.__addByRow = (row, qty) => { try{ addToCart(row, qty); }catch(e){ console.error(e); } };

    async function fetchProducts(){
      // 1) supabase-js
      const { data, error } = await supabaseClient.from(TABLE_NAME).select("*");
      if (error) throw error;
      ALL = Array.isArray(data) ? data : [];
      buildCategories(ALL);
      render();
    }

    function setupRealtime(){
      if (realtimeSubscribed) return;
      realtimeSubscribed = true;

      // Reload me throttle (që mos të bëjë 100 herë)
      const reload = async () => {
        const now = Date.now();
        if (now - lastReloadAt < 800) return;
        lastReloadAt = now;
        try{
          await fetchProducts();
          elStatus.textContent = "Gati.";
        }catch(e){
          console.error(e);
        }
      };

      supabaseClient
        .channel("public:products")
        .on("postgres_changes",
          { event: "*", schema: "public", table: TABLE_NAME },
          () => reload()
        )
        .subscribe();
    }

    async function load(){
      clearError();
      elStatus.textContent = "Duke lexuar nga Supabase…";

      try{
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        await fetchProducts();
        elStatus.textContent = "Gati.";
        setupRealtime(); // ✅ ndryshimet në Supabase dalin vetë (pa e rifresku faqe)
        return;
      }catch(e){
        console.error(e);
        showError(
          "Nuk u lexuan produktet nga Supabase. Kontrollo: RLS policy SELECT për anon, dhe key/URL. " +
          "Mesazh: " + (e?.message || e)
        );
        elStatus.textContent = "Gabim lidhjeje";
        ALL = [];
        render();
      }
    }

    elQ.addEventListener("input", render);
    elCat.addEventListener("change", render);
    elRate.addEventListener("input", () => { render(); renderCart(); });

    load();
  </script>
</body>
</html>
