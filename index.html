<!doctype html>
<html lang="sq">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gjekaj Plants â€” Katalogu i BimÃ«ve</title>

  <meta name="description" content="Gjekaj Plants â€” PemÃ« dekorative, bimÃ«, fidane dhe shkurre. Shiko katalogun, filtro sipas emrit/kategorisÃ«. DÃ«rgo kÃ«rkesÃ«n nÃ« WhatsApp +355697232425." />
  <meta name="keywords" content="pemÃ« dekorative, bimÃ« dekorative, fidane, shkurre dekorative, DajÃ§ ShkodÃ«r, katalog bimÃ«sh, Gjekaj Plants" />

  <style>
    :root{
      --bg:#f3f5f8;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --accent:#b91c1c;
      --border:#e5e7eb;
      --shadow: 0 10px 30px rgba(2,6,23,.08);
      --radius: 18px;

      /* Kjo mbron layout-in nga bare poshtÃ« (tinyhost / mobile) */
      --bottom-safe: 80px; /* rrit/ul nqs do */
    }

    *{box-sizing:border-box}
    html, body { width: 100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);

      /* IMPORTANT: mos u prish nga â€œbarâ€ poshtÃ« nÃ« hosting */
      padding-bottom: calc(var(--bottom-safe) + env(safe-area-inset-bottom));
    }

    header{
      background: linear-gradient(180deg, #0b1220 0%, #111827 100%);
      color:#fff;
      padding: 22px 16px 18px;
      position: sticky;
      top: 0;
      z-index: 50;
      border-bottom: 1px solid rgba(255,255,255,.08);
      text-align:center;
    }
    header h1{
      margin:0;
      font-size: clamp(20px, 3.6vw, 32px);
      font-weight: 900;
      line-height: 1.15;
    }
    header .sub{
      margin-top:8px;
      opacity:.9;
      font-size: 14px;
      font-weight: 650;
    }

    .wrap{
      max-width: 1200px;
      margin: 18px auto 24px;
      padding: 0 14px;
    }

    .panel{
      background: var(--card);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding: 14px;
      margin-top: 14px;
    }

    .grid-controls{
      display:grid;
      grid-template-columns: 1.3fr .8fr .9fr;
      gap: 10px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid-controls{ grid-template-columns: 1fr; }
    }

    label{
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
      display:block;
      margin: 6px 0 6px;
    }
    input, select, textarea{
      width:100%;
      padding: 12px 12px;
      border:1px solid var(--border);
      border-radius: 12px;
      font-size: 15px;
      outline: none;
      background:#fff;
    }
    textarea{ min-height: 70px; resize: vertical; }

    .bar{
      display:flex;
      justify-content: space-between;
      align-items:center;
      margin-top: 14px;
      gap: 10px;
      flex-wrap: wrap;
    }
    .count{
      font-size: 13px;
      color: var(--muted);
      font-weight: 900;
    }
    .status{
      font-size: 13px;
      font-weight: 900;
      color: var(--muted);
    }
    .error{
      display:none;
      margin-top: 14px;
      background: #fff;
      border: 1px solid #fecaca;
      border-left: 6px solid #b91c1c;
      border-radius: 14px;
      padding: 12px 12px;
      font-weight: 900;
      color:#7f1d1d;
      white-space: pre-wrap;
    }

    /* Cards */
    .cards{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 14px;
      margin-top: 14px;
    }
    @media (max-width: 1020px){ .cards{grid-template-columns: repeat(2, minmax(0,1fr));} }
    @media (max-width: 640px){ .cards{grid-template-columns: 1fr;} }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 100%;
    }
    .img{
      width:100%;
      aspect-ratio: 16/10;
      background: #e5e7eb;
      display:block;
      object-fit: cover;
    }
    .content{
      padding: 12px 12px 14px;
      display:flex;
      flex-direction:column;
      gap: 8px;
      flex:1;
    }
    .name{
      margin:0;
      font-size: 20px;
      font-weight: 950;
    }
    .meta{
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
      font-weight: 700;
    }
    .price{
      display:flex;
      align-items: baseline;
      gap: 10px;
      flex-wrap: wrap;
    }
    .lek{
      color: var(--accent);
      font-weight: 1000;
      font-size: 26px;
    }
    .eur{
      color: #334155;
      font-weight: 950;
      font-size: 18px;
    }
    .desc{
      color:#334155;
      font-size: 13px;
      line-height:1.35;
      font-weight: 650;
      opacity:.95;
    }
    .buyrow{
      display:flex;
      gap: 10px;
      align-items:center;
      margin-top: 6px;
      flex-wrap: wrap;
    }
    .qty{ width: 90px; }
    .btnAdd{
      flex:1;
      min-width: 160px;
      background: #111827;
      color: #fff;
      border: 0;
      border-radius: 14px;
      padding: 12px 12px;
      font-weight: 1000;
      cursor:pointer;
      font-size: 15px;
    }

    /* Kurs + ShportÃ« */
    .rateCartCol{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .cartbox{
      background:#0b1220;
      color:#fff;
      border-radius: 16px;
      padding: 12px;
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 16px 45px rgba(2,6,23,.18);
    }
    .rateCartCol .cartbox{
      position: sticky;
      top: 96px;
      max-height: calc(100vh - 140px);
      overflow: auto;
      z-index: 40;
    }

    .cartbox h2{
      margin: 4px 0 10px;
      font-size: 16px;
      font-weight: 1000;
    }
    .cartlist{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .cartitem{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding: 10px;
      display:grid;
      grid-template-columns: 1fr 86px;
      gap: 10px;
      align-items:start;
    }
    .cartitem .t{ font-weight: 1000; font-size: 13.5px; }
    .cartitem .s{ margin-top: 4px; font-size: 12.5px; opacity:.9; }
    .cartitem .q{ display:flex; flex-direction:column; gap: 8px; }
    .cartitem input{
      width: 100%;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.10);
      color:#fff;
      font-weight: 1000;
      text-align:center;
    }
    .btnDel{
      width:100%;
      border:0;
      border-radius: 12px;
      padding: 10px 10px;
      cursor:pointer;
      font-weight: 1000;
      background: rgba(244,63,94,.22);
      color:#fff;
    }

    .totals{
      margin-top: 12px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
    }
    .totals .big{ font-size: 20px; font-weight: 1100; }
    .totals .small{ font-size: 14px; font-weight: 1000; opacity:.95; }

    .note{ margin-top: 10px; }
    .note textarea{
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.14);
      color:#fff;
    }

    .cartActions{
      display:flex;
      gap: 10px;
      margin-top: 10px;
    }
    .btnClear{
      width: 100%;
      background: rgba(255,255,255,.10);
      color:#fff;
      border:1px solid rgba(255,255,255,.20);
      border-radius: 14px;
      padding: 12px 12px;
      font-weight: 1100;
      cursor:pointer;
      font-size: 15px;
    }
    .send{
      margin-top: 10px;
      width:100%;
      background:#16a34a;
      color:#fff;
      border:0;
      border-radius: 14px;
      padding: 13px 12px;
      font-weight: 1100;
      cursor:pointer;
      font-size: 16px;
    }
    .send:disabled{ opacity:.55; cursor:not-allowed; }

    /* Footer normal (jo fixed) -> identik nÃ« GitHub & tiny.site */
    footer{
      margin-top: 18px;
      background: #111827;
      color:#fff;
      padding: 10px 14px;
      text-align:center;
      font-weight: 1000;
      border-top: 1px solid rgba(255,255,255,.08);
      border-radius: 16px;
    }
  </style>
</head>

<body>
  <header>
    <h1>Gjekaj Plants â€” Katalogu i BimÃ«ve</h1>
    <div class="sub">DajÃ§, ShkodÃ«r, Albania â€¢ Tel: +355697232425</div>
  </header>

  <div class="wrap">
    <div id="err" class="error"></div>

    <div class="panel">
      <div class="grid-controls">
        <div>
          <label>KÃ«rko (emÃ«r / kategori / kod)</label>
          <input id="q" placeholder="p.sh. cipresus, 019, dekorative..." />
        </div>

        <div>
          <label>Kategori</label>
          <select id="cat">
            <option value="">TÃ« gjitha kategoritÃ«</option>
          </select>
        </div>

        <div class="rateCartCol">
          <div>
            <label>Kursi â‚¬ â†’ Lek (1â‚¬ = 100)</label>
            <input id="rate" type="number" inputmode="numeric" min="1" step="1" value="100" />
          </div>

          <div class="cartbox" id="cartBox">
            <h2>Shporta</h2>
            <div id="cartItems" class="cartlist"></div>

            <div class="totals">
              <div class="big" id="cartTotalLek">0 LekÃ«</div>
              <div class="small" id="cartTotalEur">0.00 â‚¬</div>
            </div>

            <div class="note">
              <label style="color: rgba(255,255,255,.85); font-weight:1000">ShÃ«nim (opsionale)</label>
              <textarea id="note" placeholder="p.sh. dÃ«rgesÃ« / orari / kÃ«rkesa speciale..."></textarea>
            </div>

            <div class="cartActions">
              <button id="clearCart" class="btnClear" type="button">Pastro shportÃ«n</button>
            </div>

            <button id="sendWA" class="send" disabled>DÃ«rgo nÃ« WhatsApp</button>
          </div>
        </div>
      </div>

      <div class="bar">
        <div class="count" id="count">0 artikuj</div>
        <div class="status" id="status">Duke u lidhurâ€¦</div>
      </div>
    </div>

    <div class="cards" id="cards"></div>

    <footer>Gjekaj Plants â€¢ WhatsApp: 0697232425</footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Supabase
    const SUPABASE_URL = "https://oehcfyfjlwvlqowjezwg.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_Ll_tV3Hs9MmMO54DaDWGiQ_KRpED8xd";
    const TABLE_NAME = "products";

    // Kolonat
    const COL_CATEGORY = "category";
    const COL_CODE     = "code";
    const COL_STOCK    = "stock";
    const COL_PRICELEK = "price_lek";

    const NAME_KEYS = ["name","title","emri"];
    const DESC_KEYS = ["description","desc","pershkrimi","pershkrim"];
    const IMG_KEYS  = ["photo_url","image_url","img_url","photo","image","foto","url_photo","url_image"];

    // WhatsApp (pa +)
    const WHATSAPP_NUMBER = "355697232425";

    // UI
    const elErr = document.getElementById("err");
    const elCards = document.getElementById("cards");
    const elCount = document.getElementById("count");
    const elStatus = document.getElementById("status");
    const elQ = document.getElementById("q");
    const elCat = document.getElementById("cat");
    const elRate = document.getElementById("rate");

    const cartItemsEl = document.getElementById("cartItems");
    const cartTotalLekEl = document.getElementById("cartTotalLek");
    const cartTotalEurEl = document.getElementById("cartTotalEur");
    const noteEl = document.getElementById("note");
    const clearCartBtn = document.getElementById("clearCart");
    const sendWA = document.getElementById("sendWA");

    function showError(msg){
      elErr.style.display = "block";
      elErr.textContent = msg;
    }
    function clearError(){
      elErr.style.display = "none";
      elErr.textContent = "";
    }
    function firstExisting(row, keys){
      for (const k of keys){
        if (row && row[k] !== undefined && row[k] !== null && String(row[k]).trim() !== "") return row[k];
      }
      return "";
    }
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function toNumber(v){
      if (v === null || v === undefined) return 0;
      const s = String(v).replaceAll(".", "").replaceAll(",", ".").replace(/[^\d.]/g, "");
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    }
    function formatLek(n){
      const x = Math.round(n);
      return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }
    function formatEuro(n){
      return (Math.round(n * 100) / 100).toFixed(2);
    }

    let ALL = [];
    let CART = {}; // {id: {row, qty}}

    function saveCart(){
      try{
        localStorage.setItem("gjekaj_cart_v2", JSON.stringify({ cart: CART, note: noteEl.value || "" }));
      }catch{}
    }
    function loadCart(){
      try{
        const raw = localStorage.getItem("gjekaj_cart_v2");
        if (!raw) return;
        const obj = JSON.parse(raw);
        CART = obj?.cart || {};
        noteEl.value = obj?.note || "";
      }catch{}
    }

    function buildCategories(rows){
      const set = new Set();
      for (const r of rows){
        const c = (r?.[COL_CATEGORY] ?? "").toString().trim();
        if (c) set.add(c);
      }
      const cats = Array.from(set).sort((a,b)=>a.localeCompare(b));
      const current = elCat.value;
      elCat.innerHTML = <option value="">TÃ« gjitha kategoritÃ«</option> + cats.map(c => <option value="${escapeHtml(c)}">${escapeHtml(c)}</option>).join("");
      if (cats.includes(current)) elCat.value = current;
    }

    function calcTotals(){
      const rate = Math.max(1, toNumber(elRate.value || 100));
      let totalLek = 0;
      for (const id of Object.keys(CART)){
        const it = CART[id];
        const priceLek = toNumber(it?.row?.[COL_PRICELEK]);
        const qty = Math.max(1, toNumber(it?.qty || 1));
        totalLek += priceLek * qty;
      }
      const totalEur = totalLek / rate;

      cartTotalLekEl.textContent = ${formatLek(totalLek)} LekÃ«;
      cartTotalEurEl.textContent = ${formatEuro(totalEur)} â‚¬;

      sendWA.disabled = totalLek <= 0;
      saveCart();
      return { totalLek, totalEur, rate };
    }

    function renderCart(){
      const ids = Object.keys(CART);
      if (ids.length === 0){
        cartItemsEl.innerHTML = <div style="opacity:.9;font-weight:900;">Shporta Ã«shtÃ« bosh.</div>;
        calcTotals();
        return;
      }

      cartItemsEl.innerHTML = ids.map(id => {
        const it = CART[id];
        const r = it.row || {};
        const name = firstExisting(r, NAME_KEYS) || "(pa emÃ«r)";
        const category = (r?.[COL_CATEGORY] ?? "").toString();
        const code = (r?.[COL_CODE] ?? "").toString();
        const priceLek = toNumber(r?.[COL_PRICELEK]);
        const qty = Math.max(1, toNumber(it.qty || 1));

        return `
          <div class="cartitem">
            <div>
              <div class="t">${escapeHtml(name)}</div>
              <div class="s">
                ${category ? Kategoria: <b>${escapeHtml(category)}</b><br> : ``}
                ${code ? Kodi: <b>${escapeHtml(code)}</b><br> : ``}
                Ã‡mimi: <b>${formatLek(priceLek)} LekÃ«</b>
              </div>
            </div>
            <div class="q">
              <input type="number" min="1" step="1" value="${qty}" data-id="${escapeHtml(id)}" class="qtyInCart" />
              <button class="btnDel" data-del="${escapeHtml(id)}">Hiq</button>
            </div>
          </div>
        `;
      }).join("");

      cartItemsEl.querySelectorAll(".qtyInCart").forEach(inp=>{
        inp.addEventListener("input", ()=>{
          const id = inp.getAttribute("data-id");
          const v = Math.max(1, toNumber(inp.value || 1));
          if (CART[id]) CART[id].qty = v;
          calcTotals();
        });
      });
      cartItemsEl.querySelectorAll("[data-del]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-del");
          delete CART[id];
          renderCart();
        });
      });

      calcTotals();
    }

    function addToCart(row, qty){
      const id = String(row?.id ?? row?.[COL_CODE] ?? firstExisting(row, NAME_KEYS));
      const q = Math.max(1, toNumber(qty || 1));

      if (!CART[id]) CART[id] = { row, qty: q };
      else CART[id].qty = Math.max(1, toNumber(CART[id].qty || 1) + q);

      renderCart();
    }

    function renderProducts(){
      clearError();

      const q = elQ.value.trim().toLowerCase();
      const cat = elCat.value.trim();
      const rate = Math.max(1, toNumber(elRate.value || 100));

      const filtered = ALL.filter(r => {
        if (cat && String(r?.[COL_CATEGORY] ?? "").trim() !== cat) return false;
        if (!q) return true;

        const name = firstExisting(r, NAME_KEYS).toString().toLowerCase();
        const category = (r?.[COL_CATEGORY] ?? "").toString().toLowerCase();
        const code = (r?.[COL_CODE] ?? "").toString().toLowerCase();

        return name.includes(q) || category.includes(q) || code.includes(q);
      });

      elCount.textContent = ${filtered.length} artikuj;

      elCards.innerHTML = filtered.map(r => {
        const name = firstExisting(r, NAME_KEYS) || "(pa emÃ«r)";
        const desc = firstExisting(r, DESC_KEYS) || "";
        const img = firstExisting(r, IMG_KEYS) || "";
        const category = (r?.[COL_CATEGORY] ?? "").toString();
        const code = (r?.[COL_CODE] ?? "").toString();
        const stock = (r?.[COL_STOCK] ?? "").toString();

        const priceLek = toNumber(r?.[COL_PRICELEK]);
        const priceEur = priceLek / rate;

        const imgTag = img
          ? `<img class="img" src="${escapeHtml(img)}" alt="${escapeHtml(name)}" loading="lazy"
               onerror="this.style.display='none'; this.parentNode.style.background='#e5e7eb';" />`
          : <div class="img"></div>;

        const pid = escapeHtml(String(r?.id ?? code ?? name));

        return `
          <article class="card">
            ${imgTag}
            <div class="content">
              <h3 class="name">${escapeHtml(name)}</h3>

              <div class="meta">
                ${category ? Kategoria: <b>${escapeHtml(category)}</b><br> : ``}
                ${code ? Kodi: <b>${escapeHtml(code)}</b><br> : ``}
                ${stock ? Stok: <b>${escapeHtml(stock)}</b> : ``}
              </div>

              <div class="price">
                <div class="lek">${formatLek(priceLek)} LekÃ«</div>
                <div class="eur">${formatEuro(priceEur)} â‚¬</div>
              </div>

              ${desc ? <div class="desc">${escapeHtml(desc)}</div> : ``}

              <div class="buyrow">
                <input class="qty" type="number" min="1" step="1" value="1" id="qty_${pid}" />
                <button class="btnAdd" data-add="${pid}">Shto nÃ« shportÃ«</button>
              </div>
            </div>
          </article>
        `;
      }).join("");

      elCards.querySelectorAll("[data-add]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const pid = btn.getAttribute("data-add");
          const qtyEl = document.getElementById("qty_" + pid);
          const qty = Math.max(1, toNumber(qtyEl?.value || 1));

          const row = filtered.find(r=>{
            const rid = String(r?.id ?? "");
            const rcode = String(r?.[COL_CODE] ?? "");
            const rname = String(firstExisting(r, NAME_KEYS) ?? "");
            return (rid && rid === pid) || (rcode && rcode === pid) || (rname && rname === pid);
          });

          if (row) addToCart(row, qty);
        });
      });

      calcTotals();
    }

    async function load(){
      clearError();
      elStatus.textContent = "Duke lexuar nga Supabaseâ€¦";

      try{
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const { data, error } = await supabase.from(TABLE_NAME).select("*");
        if (error) throw error;

        ALL = Array.isArray(data) ? data : [];
        buildCategories(ALL);
        renderProducts();
        elStatus.textContent = "Gati.";
      }catch(e){
        console.error(e);
        showError("Nuk u lidh me Supabase. Kontrollo RLS policy (SELECT pÃ«r anon) dhe tabelÃ«n 'products'.\nMesazh: " + (e?.message || e));
        elStatus.textContent = "Gabim";
      }
    }

    function buildWhatsAppMessage(){
      const { totalLek, totalEur, rate } = calcTotals();
      const note = (noteEl.value || "").trim();
      const lines = [];
      lines.push("ðŸ“Œ KÃ«rkesÃ« nga Katalogu â€” Gjekaj Plants");
      lines.push("");

      for (const id of Object.keys(CART)){
        const it = CART[id];
        const r = it.row || {};
        const name = firstExisting(r, NAME_KEYS) || "(pa emÃ«r)";
        const code = (r?.[COL_CODE] ?? "").toString();
        const priceLek = toNumber(r?.[COL_PRICELEK]);
        const qty = Math.max(1, toNumber(it.qty || 1));
        const subLek = priceLek * qty;
        const subEur = subLek / rate;

        lines.push(â€¢ ${name}${code ? " (Kodi: "+code+")" : ""});
        lines.push(`  Sasia: ${qty} | NÃ«n-total: ${formatLek(subLek)} LekÃ« (${formatEuro(subEur)} â‚¬)`);
      }

      lines.push("");
      lines.push(Totali: ${formatLek(totalLek)} LekÃ« (${formatEuro(totalEur)} â‚¬));
      lines.push(Kursi: 1â‚¬ = ${rate} Lek);

      if (note){
        lines.push("");
        lines.push("ShÃ«nim:");
        lines.push(note);
      }
      return lines.join("\n");
    }

    elQ.addEventListener("input", renderProducts);
    elCat.addEventListener("change", renderProducts);
    elRate.addEventListener("input", ()=>{ renderProducts(); renderCart(); });
    noteEl.addEventListener("input", saveCart);

    clearCartBtn.addEventListener("click", ()=>{
      if (!confirm("Me e pastru shportÃ«n komplet?")) return;
      CART = {};
      noteEl.value = "";
      renderCart();
    });

    sendWA.addEventListener("click", ()=>{
      const msg = buildWhatsAppMessage();
      const url = https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)};
      window.open(url, "_blank");
    });

    loadCart();
    renderCart();
    load();
  </script>
</body>
</html>
