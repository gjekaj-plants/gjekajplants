<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  // Supabase
  const SUPABASE_URL = "https://oehcfyfjlwvlqowjezwg.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_Ll_tV3Hs9MmMO54DaDWGiQ_KRpED8xd";
  const TABLE_NAME = "products";

  // Kolonat
  const COL_CATEGORY = "category";
  const COL_CODE     = "code";
  const COL_STOCK    = "stock";
  const COL_PRICELEK = "price_lek";

  const NAME_KEYS = ["name","title","emri"];
  const DESC_KEYS = ["description","desc","pershkrimi","pershkrim"];
  const IMG_KEYS  = ["photo_url","image_url","img_url","photo","image","foto","url_photo","url_image"];

  // WhatsApp (pa +)
  const WHATSAPP_NUMBER = "355697232425";

  // UI
  const elErr = document.getElementById("err");
  const elCards = document.getElementById("cards");
  const elCount = document.getElementById("count");
  const elStatus = document.getElementById("status");
  const elQ = document.getElementById("q");
  const elCat = document.getElementById("cat");
  const elRate = document.getElementById("rate");

  const cartItemsEl = document.getElementById("cartItems");
  const cartTotalLekEl = document.getElementById("cartTotalLek");
  const cartTotalEurEl = document.getElementById("cartTotalEur");
  const noteEl = document.getElementById("note");
  const clearCartBtn = document.getElementById("clearCart");
  const sendWA = document.getElementById("sendWA");

  function showError(msg){
    elErr.style.display = "block";
    elErr.textContent = msg;
  }
  function clearError(){
    elErr.style.display = "none";
    elErr.textContent = "";
  }
  function firstExisting(row, keys){
    for (const k of keys){
      if (row && row[k] !== undefined && row[k] !== null && String(row[k]).trim() !== "") return row[k];
    }
    return "";
  }
  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function toNumber(v){
    if (v === null || v === undefined) return 0;
    const s = String(v).replaceAll(".", "").replaceAll(",", ".").replace(/[^\d.]/g, "");
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }
  function formatLek(n){
    const x = Math.round(n);
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }
  function formatEuro(n){
    return (Math.round(n * 100) / 100).toFixed(2);
  }

  // Data
  let ALL = [];
  let CART = {}; // {id: {row, qty}}

  function saveCart(){
    try{
      localStorage.setItem("gjekaj_cart_v2", JSON.stringify({ cart: CART, note: noteEl.value || "" }));
    }catch{}
  }
  function loadCart(){
    try{
      const raw = localStorage.getItem("gjekaj_cart_v2");
      if (!raw) return;
      const obj = JSON.parse(raw);
      CART = obj?.cart || {};
      noteEl.value = obj?.note || "";
    }catch{}
  }

  function buildCategories(rows){
    const set = new Set();
    for (const r of rows){
      const c = (r?.[COL_CATEGORY] ?? "").toString().trim();
      if (c) set.add(c);
    }
    const cats = Array.from(set).sort((a,b)=>a.localeCompare(b));
    const current = elCat.value;
    elCat.innerHTML = <option value="">TÃ« gjitha kategoritÃ«</option> + cats.map(c => <option value="${escapeHtml(c)}">${escapeHtml(c)}</option>).join("");
    if (cats.includes(current)) elCat.value = current;
  }

  function calcTotals(){
    const rate = Math.max(1, toNumber(elRate.value || 100));
    let totalLek = 0;
    for (const id of Object.keys(CART)){
      const it = CART[id];
      const priceLek = toNumber(it?.row?.[COL_PRICELEK]);
      const qty = Math.max(1, toNumber(it?.qty || 1));
      totalLek += priceLek * qty;
    }
    const totalEur = totalLek / rate;

    cartTotalLekEl.textContent = ${formatLek(totalLek)} LekÃ«;
    cartTotalEurEl.textContent = ${formatEuro(totalEur)} â‚¬;

    sendWA.disabled = totalLek <= 0;
    saveCart();
    return { totalLek, totalEur, rate };
  }

  function renderCart(){
    const ids = Object.keys(CART);
    if (ids.length === 0){
      cartItemsEl.innerHTML = <div style="opacity:.9;font-weight:900;">Shporta Ã«shtÃ« bosh.</div>;
      calcTotals();
      return;
    }

    cartItemsEl.innerHTML = ids.map(id => {
      const it = CART[id];
      const r = it.row || {};
      const name = firstExisting(r, NAME_KEYS) || "(pa emÃ«r)";
      const category = (r?.[COL_CATEGORY] ?? "").toString();
      const code = (r?.[COL_CODE] ?? "").toString();
      const priceLek = toNumber(r?.[COL_PRICELEK]);
      const qty = Math.max(1, toNumber(it.qty || 1));

      return `
        <div class="cartitem">
          <div>
            <div class="t">${escapeHtml(name)}</div>
            <div class="s">
              ${category ? Kategoria: <b>${escapeHtml(category)}</b><br> : ``}
              ${code ? Kodi: <b>${escapeHtml(code)}</b><br> : ``}
              Ã‡mimi: <b>${formatLek(priceLek)} LekÃ«</b>
            </div>
          </div>
          <div class="q">
            <input type="number" min="1" step="1" value="${qty}" data-id="${escapeHtml(id)}" class="qtyInCart" />
            <button class="btnDel" data-del="${escapeHtml(id)}">Hiq</button>
          </div>
        </div>
      `;
    }).join("");

    cartItemsEl.querySelectorAll(".qtyInCart").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const id = inp.getAttribute("data-id");
        const v = Math.max(1, toNumber(inp.value || 1));
        if (CART[id]) CART[id].qty = v;
        calcTotals();
      });
    });
    cartItemsEl.querySelectorAll("[data-del]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-del");
        delete CART[id];
        renderCart();
      });
    });

    calcTotals();
  }

  function addToCart(row, qty){
    const id = String(row?.id ?? row?.[COL_CODE] ?? firstExisting(row, NAME_KEYS));
    const q = Math.max(1, toNumber(qty || 1));

    if (!CART[id]) CART[id] = { row, qty: q };
    else CART[id].qty = Math.max(1, toNumber(CART[id].qty || 1) + q);

    renderCart();
  }

  function renderProducts(){
    clearError();

    const q = elQ.value.trim().toLowerCase();
    const cat = elCat.value.trim();
    const rate = Math.max(1, toNumber(elRate.value || 100));

    const filtered = ALL.filter(r => {
      if (cat && String(r?.[COL_CATEGORY] ?? "").trim() !== cat) return false;
      if (!q) return true;

      const name = firstExisting(r, NAME_KEYS).toString().toLowerCase();
      const category = (r?.[COL_CATEGORY] ?? "").toString().toLowerCase();
      const code = (r?.[COL_CODE] ?? "").toString().toLowerCase();

      return name.includes(q) || category.includes(q) || code.includes(q);
    });

    elCount.textContent = ${filtered.length} artikuj;

    elCards.innerHTML = filtered.map(r => {
      const name = firstExisting(r, NAME_KEYS) || "(pa emÃ«r)";
      const desc = firstExisting(r, DESC_KEYS) || "";
      const img = firstExisting(r, IMG_KEYS) || "";
      const category = (r?.[COL_CATEGORY] ?? "").toString();
      const code = (r?.[COL_CODE] ?? "").toString();
      const stock = (r?.[COL_STOCK] ?? "").toString();

      const priceLek = toNumber(r?.[COL_PRICELEK]);
      const priceEur = priceLek / rate;

      const imgTag = img
        ? `<img class="img" src="${escapeHtml(img)}" alt="${escapeHtml(name)}" loading="lazy"
             onerror="this.style.display='none'; this.parentNode.style.background='#e5e7eb';" />`
        : <div class="img"></div>;

      const pid = escapeHtml(String(r?.id ?? code ?? name));

      return `
        <article class="card">
          ${imgTag}
          <div class="content">
            <h3 class="name">${escapeHtml(name)}</h3>

            <div class="meta">
              ${category ? Kategoria: <b>${escapeHtml(category)}</b><br> : ``}
              ${code ? Kodi: <b>${escapeHtml(code)}</b><br> : ``}
              ${stock ? Stok: <b>${escapeHtml(stock)}</b> : ``}
            </div>

            <div class="price">
              <div class="lek">${formatLek(priceLek)} LekÃ«</div>
              <div class="eur">${formatEuro(priceEur)} â‚¬</div>
            </div>

            ${desc ? <div class="desc">${escapeHtml(desc)}</div> : ``}

            <div class="buyrow">
              <input class="qty" type="number" min="1" step="1" value="1" id="qty_${pid}" />
              <button class="btnAdd" data-add="${pid}">Shto nÃ« shportÃ«</button>
            </div>
          </div>
        </article>
      `;
    }).join("");

    elCards.querySelectorAll("[data-add]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const pid = btn.getAttribute("data-add");
        const qtyEl = document.getElementById("qty_" + pid);
        const qty = Math.max(1, toNumber(qtyEl?.value || 1));

        const row = filtered.find(r=>{
          const rid = String(r?.id ?? "");
          const rcode = String(r?.[COL_CODE] ?? "");
          const rname = String(firstExisting(r, NAME_KEYS) ?? "");
          return (rid && rid === pid) || (rcode && rcode === pid) || (rname && rname === pid);
        });

        if (row) addToCart(row, qty);
      });
    });

    calcTotals();
  }

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  async function load(){
    clearError();
    elStatus.textContent = "Duke lexuar nga Supabaseâ€¦";

    try{
      const { data, error } = await supabase.from(TABLE_NAME).select("*");
      if (error) throw error;

      ALL = Array.isArray(data) ? data : [];
      buildCategories(ALL);
      renderProducts();
      elStatus.textContent = "Gati.";
    }catch(e){
      console.error(e);
      showError("Nuk u lidh me Supabase.\nMesazh: " + (e?.message || e));
      elStatus.textContent = "Gabim";
    }
  }

  function buildWhatsAppMessage(){
    const { totalLek, totalEur, rate } = calcTotals();
    const note = (noteEl.value || "").trim();
    const lines = [];
    lines.push("ðŸ“Œ KÃ«rkesÃ« nga Katalogu â€” Gjekaj Plants");
    lines.push("");

    for (const id of Object.keys(CART)){
      const it = CART[id];
      const r = it.row || {};
      const name = firstExisting(r, NAME_KEYS) || "(pa emÃ«r)";
      const code = (r?.[COL_CODE] ?? "").toString();
      const priceLek = toNumber(r?.[COL_PRICELEK]);
      const qty = Math.max(1, toNumber(it.qty || 1));
      const subLek = priceLek * qty;
      const subEur = subLek / rate;

      lines.push(â€¢ ${name}${code ? " (Kodi: "+code+")" : ""});
      lines.push(`  Sasia: ${qty} | NÃ«n-total: ${formatLek(subLek)} LekÃ« (${formatEuro(subEur)} â‚¬)`);
    }

    lines.push("");
    lines.push(Totali: ${formatLek(totalLek)} LekÃ« (${formatEuro(totalEur)} â‚¬));
    lines.push(Kursi: 1â‚¬ = ${rate} Lek);

    if (note){
      lines.push("");
      lines.push("ShÃ«nim:");
      lines.push(note);
    }
    return lines.join("\n");
  }

  // Events
  elQ.addEventListener("input", renderProducts);
  elCat.addEventListener("change", renderProducts);
  elRate.addEventListener("input", ()=>{ renderProducts(); renderCart(); });
  noteEl.addEventListener("input", saveCart);

  clearCartBtn.addEventListener("click", ()=>{
    if (!confirm("Me e pastru shportÃ«n komplet?")) return;
    CART = {};
    noteEl.value = "";
    renderCart();
  });

  sendWA.addEventListener("click", ()=>{
    const msg = buildWhatsAppMessage();
    const url = https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)};
    window.open(url, "_blank");
  });

  // Start
  loadCart();
  renderCart();
  load();
</script>
